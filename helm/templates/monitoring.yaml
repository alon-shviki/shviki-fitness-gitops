# Summary: ArgoCD Application for Monitoring Stack (Prometheus + Grafana)
# Description:
# Deploys kube-prometheus-stack using Helm.
# Includes namespace creation, server-side apply, pruning rules,
# and CRD difference ignoring for stable sync behavior.

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: monitoring
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook-delete-policy: "HookSucceeded"
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  source:
    repoURL: {{ .Values.apps.monitoring.repoURL }}
    chart: {{ .Values.apps.monitoring.chart }}
    targetRevision: {{ .Values.apps.monitoring.version }}
    helm:
      values: |
        # Monitoring values defined in values.yaml

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - Prune=true

  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      name: prometheusagents.monitoring.coreos.com
      jsonPointers:
        - /status
