# Summary: External Secrets Operator ArgoCD Application
# Description:
# Deploys the External Secrets Operator via ArgoCD using the official Helm chart.
# Uses the pre-created IAM-annotated service account (created by Terraform).
# CRDs are installed by Helm, and namespace creation is disabled because Terraform manages it.

# FILE: shviki-fitness-gitops/helm/templates/external-secrets.yaml

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-secrets
  namespace: argocd
  annotations:
    # Sync before core apps (ensures operator exists first)
    argocd.argoproj.io/sync-wave: "-1"
spec:
  project: default

  # ArgoCD deploys the operator into the existing namespace
  destination:
    server: https://kubernetes.default.svc
    namespace: external-secrets

  source:
    repoURL: {{ .Values.apps.externalSecrets.repoURL }}
    chart: {{ .Values.apps.externalSecrets.chart }}
    targetRevision: {{ .Values.apps.externalSecrets.version }}
    helm:
      values: |
        # Install all required CRDs
        installCRDs: true

        # Use the IAM-annotated service account from Terraform
        serviceAccount:
          create: false
          name: "external-secrets-sa"

        # Node scheduling for operator placement
        nodeSelector:
{{ toYaml .Values.systemNodeSelector.nodeSelector | nindent 10 }}
        tolerations:
{{ toYaml .Values.systemNodeSelector.tolerations | nindent 10 }}

  # Automated syncing with cleanup and reconciliation
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      # Namespace is managed by Terraform
      - CreateNamespace=false
