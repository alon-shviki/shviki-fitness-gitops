apiVersion: batch/v1
kind: Job
metadata:
  name: install-prometheus-crds
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: apply-crds
          image: bitnami/kubectl:latest
          command:
            - sh
            - -c
            - |
              set -e
              echo "Applying Prometheus Operator CRDs"

              # Core CRDs (lightweight)
              for crd in alertmanagers prometheusrules servicemonitors podmonitors probes scrapeconfigs; do
                echo "Applying CRD: $crd"
                kubectl apply -f "https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.67.1/example/prometheus-operator-crd/monitoring.coreos.com_${crd}.yaml" || true
              done

              # Trimmed prometheuses + prometheusagents (no giant annotations)
              echo "Applying trimmed prometheuses + prometheusagents CRDs"
              cat <<EOF | kubectl apply -f -
              apiVersion: apiextensions.k8s.io/v1
              kind: CustomResourceDefinition
              metadata:
                name: prometheuses.monitoring.coreos.com
              spec:
                group: monitoring.coreos.com
                scope: Namespaced
                names:
                  kind: Prometheus
                  plural: prometheuses
                versions:
                  - name: v1
                    served: true
                    storage: true
                    schema:
                      openAPIV3Schema:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
              ---
              apiVersion: apiextensions.k8s.io/v1
              kind: CustomResourceDefinition
              metadata:
                name: prometheusagents.monitoring.coreos.com
              spec:
                group: monitoring.coreos.com
                scope: Namespaced
                names:
                  kind: PrometheusAgent
                  plural: prometheusagents
                versions:
                  - name: v1
                    served: true
                    storage: true
                    schema:
                      openAPIV3Schema:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
              EOF

              echo "âœ… All Prometheus CRDs applied successfully"
